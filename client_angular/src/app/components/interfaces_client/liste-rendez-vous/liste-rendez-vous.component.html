<!-- Panel succès -->
<div *ngIf="showSuccessPanel"
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-800 text-white rounded-2xl shadow-xl w-96 p-6">
    <h2 class="text-xl font-bold mb-4 text-yellow-400">Succès</h2>
    <p class="mb-6">{{ successMessage }}</p>

    <div class="flex justify-end gap-4">
      <button (click)="showSuccessPanel=false"
              class="px-4 py-2 rounded-lg bg-yellow-500 text-gray-900 font-bold hover:bg-yellow-600 transition">
        Fermer
      </button>
    </div>
  </div>
</div>
<!-- Panel affichage Avis -->
<div *ngIf="showViewAvisPanel"
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
  <div class="bg-gray-800 text-white rounded-2xl shadow-xl w-96 p-6">
    <h2 class="text-xl font-bold mb-4 text-yellow-400">Avis du RDV</h2>

    <p class="mb-2"><strong>Note :</strong> {{ currentAvis?.note }}/5</p>
    <p class="mb-4"><strong>Commentaire :</strong> {{ currentAvis?.commentaire }}</p>
    <p class="text-xs text-gray-400">
      Soumis par {{ currentAvis?.utilisateurNom }} le
      {{ currentAvis?.dateCreation | date:'short' }}
    </p>

    <div class="flex justify-end mt-6">
      <button (click)="closeViewAvisPanel()"
              class="px-4 py-2 rounded-lg bg-yellow-500 text-gray-900 font-bold hover:bg-yellow-600 transition">
        Fermer
      </button>
    </div>
  </div>
</div>

<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #111827 0%, #1f2937 100%);
      color: #f3f4f6;
      min-height: 100vh;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      border: 1px solid rgba(234, 179, 8, 0.2);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .card:hover {
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
      transform: translateY(-2px);
    }

    .status-badge {
      font-size: 0.75rem;
      font-weight: 500;
      padding: 4px 12px;
      border-radius: 100px;
    }

    .nav-item {
      position: relative;
      padding: 12px 16px;
      border-radius: 8px;
      transition: all 0.2s;
      color: #9ca3af;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: #f3f4f6;
    }

    .nav-item.active {
      background: rgba(234, 179, 8, 0.1);
      color: #eab308;
      font-weight: 500;
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      height: 16px;
      width: 4px;
      background: #eab308;
      border-radius: 0 2px 2px 0;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
    }

    .rdv-date {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(234, 179, 8, 0.2);
    }

    .fade-in {
      animation: fadeIn 0.4s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .bg-gradient-custom {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.9) 0%, rgba(31, 41, 55, 0.9) 100%);
    }

    input, select {
      background: rgba(255, 255, 255, 0.05) !important;
      border: 1px solid rgba(234, 179, 8, 0.3) !important;
      color: white !important;
    }

    input:focus, select:focus {
      outline: none;
      ring: 2px;
      ring-color: #eab308;
      border-color: #eab308 !important;
    }

    ::placeholder {
      color: #9ca3af !important;
    }

    .btn-primary {
      background: #eab308;
      color: #111827;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary:hover {
      background: #f59e0b;
      transform: translateY(-1px);
    }

    .video-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -2;
      opacity: 0.3;
    }

    .video-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(17, 24, 39, 0.9) 0%, rgba(31, 41, 55, 0.8) 100%);
      z-index: -1;
    }

    /* Styles ajoutés pour l'image du véhicule */
    .vehicle-image {
      width: 80px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      margin-right: 16px;
      border: 1px solid rgba(234, 179, 8, 0.3);
    }

    .vehicle-info {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    .commercial-info {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }

    .commercial-avatar {
      width: 24px;
      height: 24px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      font-size: 12px;
      background: rgba(234, 179, 8, 0.2);
      color: #eab308;
      margin-right: 8px;
    }
  </style>


<div class="absolute inset-0 z-0">
  <video autoplay loop muted playsinline class="w-full h-full object-cover">
    <source src="assets/bg2.mp4" type="video/mp4" />
    <!-- Image de secours -->
    <img src="assets/bg-fallback.jpg" alt="Arrière-plan" class="w-full h-full object-cover" />
  </video>
  <!-- Dégradé de superposition -->
  <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/80 to-gray-900/30"></div>
</div>



<!-- Main Content -->
<div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
  <br><br>

  <!-- Content -->
  <div class="p-6">
    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <!-- En attente -->
      <div class="card status-card en-attente p-5 cursor-pointer"
           (click)="filterByStatus('EN_ATTENTE')">
        <div class="flex items-center">
          <div class="bg-yellow-500/20 p-3 rounded-lg mr-4">
            <i class="fas fa-clock text-yellow-500"></i>
          </div>
          <div>
            <h3 class="text-2xl font-semibold text-white">{{ countEnAttente }}</h3>
            <p class="text-yellow-500/70 text-sm">En attente</p>
          </div>
        </div>
      </div>

      <!-- Validés -->
      <div class="card status-card valide p-5 cursor-pointer"
           (click)="filterByStatus('VALIDE')">
        <div class="flex items-center">
          <div class="bg-green-500/20 p-3 rounded-lg mr-4">
            <i class="fas fa-check-circle text-green-500"></i>
          </div>
          <div>
            <h3 class="text-2xl font-semibold text-white">{{ countValide }}</h3>
            <p class="text-green-500/70 text-sm">Validés</p>
          </div>
        </div>
      </div>

      <!-- Refusés -->
      <div class="card status-card refuse p-5 cursor-pointer"
           (click)="filterByStatus('REFUSE')">
        <div class="flex items-center">
          <div class="bg-red-500/20 p-3 rounded-lg mr-4">
            <i class="fas fa-times-circle text-red-500"></i>
          </div>
          <div>
            <h3 class="text-2xl font-semibold text-white">{{ countRefuse }}</h3>
            <p class="text-red-500/70 text-sm">Refusés</p>
          </div>
        </div>
      </div>

      <!-- Terminés -->
      <div class="card status-card termine p-5 cursor-pointer"
           (click)="filterByStatus('TERMINE')">
        <div class="flex items-center">
          <div class="bg-purple-500/20 p-3 rounded-lg mr-4">
            <i class="fas fa-flag-checkered text-purple-500"></i>
          </div>
          <div>
            <h3 class="text-2xl font-semibold text-white">{{ countTermine }}</h3>
            <p class="text-purple-500/70 text-sm">Terminés</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Reload button -->
    <div class="flex justify-left mt-4">
      <button (click)="ngOnInit()"
              class="flex items-center gap-2 px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-white shadow-md">
        <i class="fas fa-sync-alt animate-spin-slow"></i>
        <span>Rafraîchir</span>
      </button>
    </div>
    <br>

    <!-- Liste filtrée -->
    <div class="space-y-6">

      <!-- Si aucun filtre -->
      <div *ngIf="!selectedStatus"
           class="flex items-center justify-center py-6 text-gray-400 text-base italic bg-gray-800/30 rounded-xl border border-dashed border-gray-600">
        <i class="fas fa-filter mr-2 text-yellow-500/70"></i>
        Cliquez sur un statut pour afficher les rendez-vous correspondants
      </div>

      <!-- Si filtre actif -->
      <div *ngIf="selectedStatus">
        <!-- En-tête -->
        <div class="flex items-center gap-3 mb-4">
          <h2 class="text-xl font-semibold text-white tracking-wide flex items-center">
            <i class="fas fa-calendar-check mr-2 text-yellow-500"></i>
            Rendez-vous :
          </h2>
          <span class="px-4 py-1 text-sm font-medium rounded-full shadow-sm"
                [ngClass]="getStatusBadgeClass(selectedStatus)">
        {{ selectedStatus.replace('_',' ') }}
      </span>
        </div>

        <!-- Tableau -->
        <div>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-700 bg-gray-800/40 rounded-xl overflow-hidden shadow-lg">
              <thead class="bg-gray-900/50 text-yellow-400 uppercase text-sm">
              <tr>
                <th class="px-4 py-3 text-left">Date</th>
                <th class="px-4 py-3 text-left">Heure</th>
                <th class="px-4 py-3 text-left">Véhicule</th>
                <th class="px-4 py-3 text-left">Image</th>
                <th class="px-4 py-3 text-left">Magasin</th>
                <th class="px-4 py-3 text-left">Commercial</th>
                <th class="px-4 py-3 text-left">Statut</th>
                <th class="px-4 py-3 text-center">Actions</th>
              </tr>
              </thead>
              <tbody class="divide-y divide-gray-700 text-sm text-gray-300">
              <tr *ngFor="let rdv of filteredRdvs" class="hover:bg-gray-700/30 transition">
                <!-- Date -->
                <td class="px-4 py-3">
              <span class="block font-semibold text-white">
                {{ getDay(rdv.date) }}
              </span>
                  <span class="text-yellow-500 text-xs">
                {{ getMonthLabel(rdv.date) }}
              </span>
                </td>

                <!-- Heure -->
                <td class="px-4 py-3">
                  <i class="far fa-clock mr-1 text-yellow-500/70"></i> {{ formatHeure(rdv.heure) }}

                </td>

                <!-- Véhicule -->
                <td class="px-4 py-3 font-semibold text-white">
                  {{ rdv.vehiculeMakeModel }}
                </td>

                <!-- Image -->
                <td class="px-4 py-3">
                  <img [src]="getImageUrl(rdv.vehiculeImage)"
                       [alt]="rdv.vehiculeMakeModel"
                       class="h-12 w-20 object-cover rounded-md shadow" />
                </td>

                <!-- Magasin -->
                <td class="px-4 py-3">
                  <i class="fas fa-store mr-1 text-yellow-500/70"></i> {{ rdv.magasinNom }}
                  <br />
                  <a [href]="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(rdv.magasinAdresse)"
                     target="_blank"
                     class="text-blue-400 hover:underline text-xs">
                    {{ rdv.magasinAdresse }}
                  </a>
                </td>

                <td class="px-4 py-3">
                  <div class="flex items-center gap-2">
                    <!-- Si commercial assigné -->
                    <ng-container *ngIf="rdv.commercialId != null; else notAssigned">
                      <img [src]="getImageUrl(rdv.commercialImage)"
                           alt="{{ rdv.commercialFullName }}"
                           class="w-8 h-8 rounded-full object-cover border border-yellow-400" />
                      <span>{{ rdv.commercialFullName }}</span>
                    </ng-container>

                    <!-- Sinon -->
                    <ng-template #notAssigned>
                      <span class="italic text-gray-400">Pas encore assigné</span>
                    </ng-template>
                  </div>
                </td>


                <!-- Statut -->
                <td class="px-4 py-3">
              <span class="status-badge"
                    [ngClass]="getStatusBadgeClass(rdv.statut)">
                {{ rdv.statut.replace('_', ' ') }}
              </span>
                </td>

                <!-- Actions -->
                <td class="px-4 py-3 text-center">
                  <button *ngIf="rdv.statut=='EN_ATTENTE'" (click)="startEdit(rdv)" class="text-yellow-500 hover:text-yellow-400 p-2 transition-colors">
                    <i class="fas fa-edit"></i>
                  </button>

                  <!-- Cancel Button -->
                  <button *ngIf="rdv.statut=='EN_ATTENTE'" (click)="openCancelPanel(rdv.id)"
                          class="text-red-500 hover:text-red-400 p-2 transition-colors">
                    <i class="fas fa-times"></i>
                  </button>


                  <!-- Si RDV terminé et avis déjà soumis -->
                  <button *ngIf="rdv.statut=='TERMINE' && rdv.avis"
                          (click)="viewAvis(rdv.avis)"
                          class="text-blue-500 hover:text-blue-400 p-2 transition-colors ml-2">
                    <i class="fas fa-eye"></i> Voir avis
                  </button>

                  <!-- Sinon, bouton pour soumettre un avis -->
                  <button *ngIf="rdv.statut=='TERMINE' && !rdv.avis"
                          (click)="openReviewPanel(rdv.id)"
                          class="text-green-500 hover:text-green-400 p-2 transition-colors ml-2">
                    <i class="fas fa-star"></i> Soumettre avis
                  </button>


                  <!-- Panel d'avis -->
                  <div *ngIf="showReviewPanel"
                       class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50 p-4">

                    <div class="bg-gray-800 text-white rounded-2xl shadow-xl w-full max-w-md p-6 relative">
                      <!-- Titre -->
                      <h2 class="text-2xl font-bold text-yellow-400 mb-4">Soumettre votre avis</h2>

                      <!-- Note -->
                      <div class="mb-4">
                        <label class="block mb-2 font-medium">Note :</label>
                        <div class="flex gap-1">
                          <i *ngFor="let star of [1,2,3,4,5]"
                             class="fas"
                             [ngClass]="(review?.note ?? 0) >= star ? 'fa-star text-yellow-400' : 'fa-star text-gray-500 hover:text-yellow-400 cursor-pointer'"
                             (click)="review!.note = star">
                          </i>

                        </div>
                      </div>

                      <!-- Commentaire -->
                      <div class="mb-4">
                        <label class="block mb-2 font-medium">Commentaire :</label>
                        <textarea [(ngModel)]="review.commentaire"
                                  rows="4"
                                  class="w-full p-2 rounded-lg bg-gray-700 text-white border border-yellow-500/40 focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                  placeholder="Écrivez votre commentaire..."></textarea>
                      </div>

                      <!-- Boutons -->
                      <div class="flex justify-end gap-4 mt-4">
                        <button (click)="closeReviewPanel()"
                                class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition">
                          Annuler
                        </button>
                        <button (click)="submitReview()"
                                class="px-4 py-2 rounded-lg bg-yellow-500 text-gray-900 font-bold hover:bg-yellow-600 transition">
                          Soumettre
                        </button>
                      </div>

                      <!-- Close icon -->
                      <button (click)="closeReviewPanel()"
                              class="absolute top-3 right-3 text-gray-400 hover:text-yellow-400 transition">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>


                  <!-- Cancel Confirmation Panel -->
                  <div *ngIf="showCancelPanel && cancelRdvId === rdv.id"
                       class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                    <div class="bg-gray-800 text-white rounded-2xl shadow-xl w-96 p-6">
                      <h2 class="text-xl font-bold mb-4 text-yellow-400">Annulation</h2>
                      <p class="mb-6">Voulez-vous vraiment annuler ce rendez-vous ?</p>

                      <div class="flex justify-end gap-4">
                        <button (click)="closeCancelPanel()"
                                class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 transition">
                          Annuler
                        </button>
                        <button (click)="confirmCancelRdv(rdv.id)"
                                class="px-4 py-2 rounded-lg bg-yellow-500 text-gray-900 font-bold hover:bg-yellow-600 transition">
                          Confirmer
                        </button>
                      </div>
                    </div>
                  </div>


                </td>
              </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Message si aucun résultat -->
        <ng-template #noResult>
          <div class="flex items-center justify-center py-6 text-gray-400 text-sm italic bg-gray-800/30 rounded-xl border border-dashed border-gray-600">
            <i class="fas fa-info-circle mr-2 text-yellow-500/70"></i>
            Aucun rendez-vous trouvé pour ce statut
          </div>
        </ng-template>
      </div>
    </div>

  </div>
  <!-- Formulaire d’édition en modal -->
  <div *ngIf="isEditing"
       class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">

    <div class="bg-gray-800 p-6 rounded-xl shadow-lg w-full max-w-md">
      <h3 class="text-lg font-semibold text-yellow-400 mb-4">Modifier le Rendez-Vous</h3>

      <form (ngSubmit)="updateRdv()" #editForm="ngForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Date -->
        <div>
          <label class="block text-sm text-gray-300 mb-1">Date</label>
          <input type="date"  [min]="today" [(ngModel)]="selectedRdv!.date" name="date"
                 class="w-full rounded-lg bg-gray-700 border border-gray-600 p-2 text-white">
        </div>

        <!-- Heure -->
        <div>
          <label class="block text-sm text-gray-300 mb-1">Heure</label>
          <select [(ngModel)]="selectedRdv!.heure" name="heure"
                  class="  w-full rounded-lg bg-gray-700 border border-gray-600 p-2 text-white">
            <option class="bg-gray-700" *ngFor="let hour of hours" [value]="hour">{{ hour }}</option>
          </select>
        </div>


        <!-- Boutons -->
        <div class="col-span-2 flex justify-end gap-3 mt-4">
          <button type="button" (click)="cancelEdit()"
                  class="px-4 py-2 rounded-lg bg-gray-600 hover:bg-gray-500 text-white">
            Annuler
          </button>
          <button type="submit"
                  class="px-4 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-400 text-black font-semibold">
            Sauvegarder
          </button>
        </div>
      </form>
    </div>

  </div>

</div>



<script>
  // Simple JavaScript for interactivity
  document.addEventListener('DOMContentLoaded', function() {
    // Add animation delays for fade-in elements
    const fadeElements = document.querySelectorAll('.fade-in');
    fadeElements.forEach((el, index) => {
      el.style.animationDelay = `${index * 0.1}s`;
    });

    // Add click effect to buttons
    const buttons = document.querySelectorAll('button');
    buttons.forEach(button => {
      button.addEventListener('mousedown', function() {
        this.classList.add('transform', 'scale-95');
      });

      button.addEventListener('mouseup', function() {
        this.classList.remove('transform', 'scale-95');
      });

      button.addEventListener('mouseleave', function() {
        this.classList.remove('transform', 'scale-95');
      });
    });
  });

  // Fonction pour obtenir les initiales du nom du commercial
  function getInitials(fullName) {
    if (!fullName) return 'NC';
    return fullName.split(' ').map(name => name[0]).join('').toUpperCase();
  }
</script>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
