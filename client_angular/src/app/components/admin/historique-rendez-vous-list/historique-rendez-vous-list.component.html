<div class="container mx-auto p-8">
  <div class="bg-gray-800 shadow-lg rounded-xl overflow-hidden p-6 border border-gray-600">
    <h2 class="text-2xl font-bold text-white mb-4"> Historique des rendez-vous</h2>
    <p class="text-gray-300 text-sm mb-6">Visualisez et filtrez les rendez-vous de visite véhicule par client, véhicule, commercial, date et statut.</p>

    <!-- Contrôles de recherche -->
    <div class="flex flex-wrap justify-start gap-4 mb-6">
      <!-- Recherche par client -->
      <div class="w-full sm:w-1/4 md:w-1/5">
        <div class="relative">
          <input [(ngModel)]="searchClient" type="text"
                 class="w-full py-2 px-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white transition duration-200 ease-in-out"
                 placeholder="Client">
          <span class="absolute right-3 top-2 text-gray-400"><i class="fa fa-user"></i></span>
        </div>
      </div>

      <!-- Recherche par véhicule -->
      <div class="w-full sm:w-1/4 md:w-1/5">
        <div class="relative">
          <input [(ngModel)]="searchVehicule" type="text"
                 class="w-full py-2 px-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white transition duration-200 ease-in-out"
                 placeholder="Véhicule">
          <span class="absolute right-3 top-2 text-gray-400"><i class="fa fa-car"></i></span>
        </div>
      </div>

      <!-- Recherche par commercial -->
      <div class="w-full sm:w-1/4 md:w-1/5">
        <div class="relative">
          <input [(ngModel)]="searchCommercial" type="text"
                 class="w-full py-2 px-3 border border-gray-600 bg-gray-700 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white transition duration-200 ease-in-out"
                 placeholder="Commercial">
          <span class="absolute right-3 top-2 text-gray-400"><i class="fa fa-briefcase"></i></span>
        </div>
      </div>

      <div class="w-full sm:w-1/4 md:w-1/5">
        <select [(ngModel)]="selectedStatut" class="w-full py-2 px-3 border border-gray-600 bg-gray-700 text-white rounded-lg" (change)="onFilterChange()">
          <option value="">-- Tous les statuts --</option>
          <option value="EN_ATTENTE">En attente</option>
          <option value="VALIDE">Validé</option>
          <option value="REFUSE">Refusé</option>
          <option value="TERMINE">Terminé</option>
        </select>
      </div>


      <!-- Filtrer par date (plage de début et fin) -->
      <div class="flex space-x-2 w-full sm:w-auto md:w-auto">
        <div class="flex-1 max-w-[170px]">
          <input
            type="date"
            [(ngModel)]="startDate"
            (change)="onFilterChange()"
            class="w-full py-2 px-3 border border-gray-600 bg-gray-700 text-white rounded-lg"
            placeholder="Date début"
          />
        </div>
        <div class="flex-1 max-w-[170px]">
          <input
            type="date"
            [(ngModel)]="endDate"
            (change)="onFilterChange()"
            class="w-full py-2 px-3 border border-gray-600 bg-gray-700 text-white rounded-lg"
            placeholder="Date fin"
          />
        </div>
      </div>

    </div>




    <!-- Tableau des rendez-vous -->
    <table class="table-auto w-full border-collapse border border-gray-600 text-white">
      <thead>
      <tr class="bg-gray-700">
        <th class="border border-gray-600 px-4 py-2 text-left">Date</th>
        <th class="border border-gray-600 px-4 py-2 text-left">Heure</th>
        <th class="border border-gray-600 px-4 py-2 text-left">Client</th>
        <th class="border border-gray-600 px-4 py-2 text-left">ShowRoom</th>
        <th class="border border-gray-600 px-4 py-2 text-left">Véhicule</th>
        <th class="border border-gray-600 px-4 py-2 text-left">Commercial</th>
        <th class="border border-gray-600 px-4 py-2 text-left">Statut</th>
        <th class="border border-gray-600 px-4 py-2 text-left">Actions</th>


      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let rdv of filteredRendezVousList" class="hover:bg-gray-700">
        <td class="border border-gray-600 px-4 py-2">{{ rdv.date }}</td>
        <td class="border border-gray-600 px-4 py-2">{{ rdv.heure }}</td>
        <td class="border border-gray-600 px-4 py-2">{{ rdv.clientFullName}}</td>
        <td class="border border-gray-600 px-4 py-2">{{ rdv.magasinNom}}</td>
        <td class="border border-gray-600 px-4 py-2">{{ rdv.vehiculeMakeModel }}</td>
        <td class="border border-gray-600 px-4 py-2">{{ rdv.commercialFullName || '-' }}</td>

        <td class="border border-gray-600 px-4 py-2">
  <span
    [ngClass]="{
      'bg-green-600 text-white': rdv.statut === 'VALIDE',
      'bg-red-600 text-white': rdv.statut === 'REFUSE',
      'bg-yellow-500 text-black': rdv.statut === 'EN_ATTENTE',
      'bg-gray-500 text-white': rdv.statut === 'TERMINE'
    }"
    class="px-3 py-1 rounded-full text-sm font-semibold"
  >
    {{ rdv.statut.toLowerCase().replace('_', ' ') }}
  </span>
        </td>
        <td class="border border-gray-600 px-4 py-2 text-center">
          <button
            (click)="openAvisPanel(rdv)"
            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded transition"
            title="Voir avis"
          >
            <i class="fas fa-eye"></i> <!-- ou juste "Voir avis" -->
          </button>
        </td>

      </tr>
      </tbody>
    </table>
  </div>

  <!-- Panel latéral modification -->
  <div
    *ngIf="showEditPanel"
    class="fixed inset-0 z-50 flex justify-end bg-gray-800 bg-opacity-70"
  >
    <div
      class="bg-white w-96 h-full shadow-lg rounded-l-2xl p-8 overflow-y-auto relative"
    >
      <button
        (click)="cancelEdit()"
        class="absolute top-6 left-6 text-gray-600 hover:text-gray-700 text-2xl font-semibold transition-all duration-300"
        aria-label="Fermer le panneau de modification"
      >
        ✖
      </button>

      <h3 class="text-2xl font-semibold mb-6 text-gray-800 text-center">
        Modifier le rendez-vous
      </h3>

      <form (ngSubmit)="saveRdv()" class="space-y-4">
        <div>
          <label class="block text-gray-700 font-medium mb-1" for="date">Date :</label>
          <input
            id="date"
            type="date"
            [(ngModel)]="selectedRdv!.date"
            name="date"
            required
            class="w-full border border-gray-400 rounded px-3 py-2"
          />
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="heure">Heure :</label>
          <input
            id="heure"
            type="time"
            [(ngModel)]="selectedRdv!.heure"
            name="heure"
            required
            class="w-full border border-gray-400 rounded px-3 py-2"
          />
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="commercialId">Commercial (ID) :</label>
          <input
            id="commercialId"
            type="number"
            [(ngModel)]="selectedRdv!.commercialId"
            name="commercialId"
            placeholder="ID du commercial"
            class="w-full border border-gray-400 rounded px-3 py-2"
          />
        </div>

        <div>
          <label class="block text-gray-700 font-medium mb-1" for="statut">Statut :</label>
          <select
            id="statut"
            [(ngModel)]="selectedRdv!.statut"
            name="statut"
            required
            class="w-full border border-gray-400 rounded px-3 py-2"
          >
            <option value="EN_ATTENTE">En attente</option>
            <option value="VALIDE">Validé</option>
            <option value="REFUSE">Refusé</option>
            <option value="TERMINE">Terminé</option>
          </select>
        </div>

        <div class="flex justify-end space-x-4 mt-6">
          <button
            type="button"
            (click)="cancelEdit()"
            class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500 transition"
          >
            Annuler
          </button>
          <button
            type="submit"
            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition"
          >
            Enregistrer
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- Panel latéral affichage avis -->

<div
  *ngIf="showAvisPanel"
  class="fixed inset-0 z-50 flex justify-end bg-black bg-opacity-50 backdrop-blur-sm"
>
  <!-- Panneau avec animation -->
  <div
    class="bg-white w-[420px] h-full shadow-2xl rounded-l-3xl flex flex-col animate-slideIn"
  >
    <!-- HEADER -->
    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-6 rounded-tl-3xl">
      <div class="flex justify-between items-center">
        <h3 class="text-white text-2xl font-bold flex items-center gap-2">
          <span class="material-icons">reviews</span>
          Avis du rendez-vous
        </h3>
        <button
          (click)="closeAvisPanel()"
          class="text-white hover:text-gray-200 text-2xl transition"
        >
          ✖
        </button>
      </div>
    </div>

    <!-- CONTENU -->
    <div class="p-6 space-y-6 overflow-y-auto">
      <div *ngIf="selectedRdvForAvis" class="space-y-4">
        <!-- Info Client -->
        <div class="bg-gray-50 p-4 rounded-xl shadow-sm flex items-center gap-4">
          <span class="material-icons text-indigo-500 text-3xl">person</span>
          <div>
            <p class="text-sm text-gray-500">Client</p>
            <p class="font-semibold text-gray-800">{{ selectedRdvForAvis.clientFullName }}</p>
          </div>
        </div>

        <!-- Date & Heure -->
        <div class="bg-gray-50 p-4 rounded-xl shadow-sm flex gap-4">
          <div class="flex items-center gap-2">
            <span class="material-icons text-purple-500">event</span>
            <span>{{ selectedRdvForAvis.date }}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="material-icons text-pink-500">schedule</span>
            <span>{{ selectedRdvForAvis.heure }}</span>
          </div>
        </div>

        <!-- Note avec étoiles -->
        <div class="bg-gray-50 p-4 rounded-xl shadow-sm">
          <p class="text-sm text-gray-500 mb-2">Note</p>
          <div class="flex items-center gap-1">
            <ng-container *ngIf="selectedRdvForAvis.avisNote; else noRating">
              <ng-container *ngFor="let star of [].constructor(5); let i = index">
                <span
                  class="material-icons"
                  [ngClass]="{
                    'text-yellow-400': i < selectedRdvForAvis.avisNote!,
                    'text-gray-300': i >= selectedRdvForAvis.avisNote!
                  }"
                >
                  star
                </span>
              </ng-container>
              <span class="ml-2 text-gray-600">{{ selectedRdvForAvis.avisNote }} / 5</span>
            </ng-container>
            <ng-template #noRating>
              <span class="text-gray-400">Pas encore noté</span>
            </ng-template>
          </div>
        </div>

        <!-- Commentaire -->
        <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-inner">
          <p class="text-sm text-gray-500 mb-2">Commentaire</p>
          <p class="text-gray-700 whitespace-pre-wrap">
            {{ selectedRdvForAvis.avisCommentaire || 'Aucun commentaire' }}
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

